# Poisson Image Editing Step-by-Step

## 目标和要求

- 补充 [CompTargetImage](../../../Framework2D/src/assignments/3_PoissonImageEditing/comp_target_image.cpp) 中 `clone()` 函数的功能，实现矩形区域的 Poisson 图像融合算法，把融合效果跑通；
- 利用矩阵的预分解实现实时的图像融合；
- （Optional）实现其他形状的区域（多边形等），实现多边形的扫描线算法。

## 说明

- 请确保已经按照 [ImGui 程序框架配置说明](../../../Homeworks/1_mini_draw/documents/framework_introduction.md) 配置成功框架代码，这个时候应该可以运行成功 `3_PoissonImageEditing` 项目；
- 善用 VS Code 的全局搜索功能，快捷键 `Ctrl+Shift+F`，例如你可以使用这个功能全局搜索 `HW2_TODO` 的提示，帮助快速定位到关键部分。
- **符合项目要求的结构设计、实现方法有很多，你不一定要严格按照下面的提示来实现，如果你有更好的想法，请务必实现它，并且在报告文件中详细描述。**

## 1. 实现矩形区域的 Poisson 融合算法

矩形区域的好处是内部像素的获取容易，可以直接用行、列的循环遍历，且处理 Poisson 方程的边界条件时比较规则。因此，我们先用矩形的区域实现 Poisson 图像融合算法，并用这个算法实现论文中的 seamless cloning 应用，我们已经为这个算法预留了一个名为 `kSeamless` 的 `CloneType`，你可以补充这个枚举值对应的部分。

这个算法本质上是把图像看作一个函数，求解一个给定区域上的 Poisson 方程，通过边界信息和内部的梯度场信息插值该区域中每个像素的颜色值（函数值）。相关的输入我们都可以在 `CompTargetImage` 类中获取到：

- **区域信息：** 可以从 `CompTargetImage::source_image_->get_region()` 获取到和源图像相同大小的黑白图像，其中非零像素即为区域内部的点，可以参考 `paste` 功能的实现了解对这个区域的使用；
- **边界条件：** 目标图像的像素值可以从图像 `CompTargetImage::data_` 获取；
- **内部梯度场：** 可以通过目标图像 `CompTargetImage::data_` 或源图像 `CompTargetImage::source_image_->get_data()` 获取并导出

根据以上这些信息和 Poisson 方程的离散差分形式，我们就可以列出以区域中像素值为变量的一个**大型稀疏方程组**，`Eigen` 有专门的稀疏矩阵处理功能 `<Eigen/Sparse>`，你可以学习并调用 `Eigen` 库来求解。

## 2. 实现实时的图像融合

实现了第一步以后，如果勾选 UI 上的 Realtime，可以在鼠标拖动的时候实时更新融合结果。但是有可能因为效率问题达不到实时的效果，这可能是因为在每一帧都需要对一个大型稀疏方程进行求解。

使用矩阵的**预分解**技术，实现**实时**的 Poisson Image Editing；对特定的问题使用适应的矩阵分解方法会极大的提高求解效率，提升求解稳定性。

> 对于线性方程组 $AX=b_i$ ，对于相同的 $A$ ，不同的 $b_i$ ，如果每次都重新整体求解方程组，耗时太严重。常用的做法是对 $A$ 进行预分解，这样对于不同的 $b_i$ ，只需要花费很少的时间，就可以得到解。
> 
> Eigen 库中，稀疏求解器（例如 `SparseLU`）中的函数 `compute` 就是对矩阵进行预分解。
>
> 仔细思考：使用**一种**稀疏方程组求解方法（LU，QR，cholesky，……）求解线性方程组。有些方法不适用该问题，可能效率很低，也可能求解失败。请选择一种适合的方法。

> 也请确保最终结果是在 Release 模式下运行，Debug 模式下运行也会对计算效率产生较大影响。

## 3. 实现复杂形状区域的 Poisson 融合（Optional）

对于形状的选取功能主要在 `CompSourceImage` 类中实现，其关键是根据不同的 `RegionType` 补充 `select_region()` 函数。在形状的设计和绘制方面，你可以仿照或者修改复用作业 1 的代码。此外，对于多边形，要想获取其区域中的像素点，可以学习实现[多边形的扫描线算法](ScanningLine.md)。

获取了复杂区域的像素之后，第二个任务就是根据这个区域列出离散的 Poisson 方程。完成这两个部分之后，基本上就实现了复杂形状区域的 Poisson 融合。

## 4. 类的设计

在实现过程中会发现，Poisson 方程求解根据**内部梯度场约束不同**有不同的实现方式，例如使用源图像的梯度，或者是使用混合梯度；此外，区域选择函数根据**不同区域类型**也有不同的实现。结合 C++ 的**面向对象特性**，你可以抽象和设计合适的类结构来封装本次作业实现的功能。



